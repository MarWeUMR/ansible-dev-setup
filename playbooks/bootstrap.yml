---

- name: Bootstrap localhost
  hosts: localhost

  handlers:

    - name: Remove passwordless sudo permissions
      ansible.builtin.file:
        path: "{{ sudoers }}"
        state: absent
      become: true

    - name: Restart dock to apply changes
      ansible.builtin.command: killall Dock
      changed_when: false
      become: true

  tasks:

    - name: Print all variables
      debug:
        var: hostvars[inventory_hostname]

    - name: Debug
      ansible.builtin.debug:
        msg: "{{ sudoers }}"

    - name: Add temporary passwordless sudo permissions
      ansible.builtin.template:
        src: sudoers.j2
        dest: "{{ sudoers }}"
        validate: /usr/sbin/visudo -csf %s
        mode: 644
      become: true
      notify: Remove passwordless sudo permissions

    # TODO: this should be replaced by systemd check
    - name: Check if inside docker container
      shell: grep -q docker /proc/1/cgroup
      register: in_docker
      changed_when: false
      failed_when: false

    - name: Add DNS fallback
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^#?FallbackDNS='
        line: FallbackDNS=9.9.9.9 1.1.1.1 8.8.8.8
      become: true
      when: in_docker.rc != 0
      # when: "'Linux' in ansible_system"

    - name: Include os-specific package tasks
      ansible.builtin.include_tasks: "tasks/bootstrap/packages/os_{{ ansible_system }}.yml"
      tags: always

    # - name: Install root dotfiles
    #   ansible.builtin.copy:
    #     src: root/
    #     dest: "{{ root_home }}/"
    #     mode: 644
    #   become: true
    #   tags: [ root, dotfiles ]

    - name: Configure system settings
      ansible.builtin.include_tasks: "tasks/bootstrap/system/os_{{ ansible_system }}.yml"
      tags: always

- name: Import dotfiles playbook
  ansible.builtin.import_playbook: dotfiles.yml
  tags: dotfiles

- name: Import secrets playbook
  ansible.builtin.import_playbook: secrets.yml
  tags: secrets
